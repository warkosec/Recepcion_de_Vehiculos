{% extends "base.html" %}

{% block title %}Recepción de Vehículo{% endblock %}

{% block content %}
<h1>Recepción de Vehículo</h1>
<div class="form-container">
    <form class="form-box" action="{{ url_for('vehicle_reception') }}" method="POST">
        <div class="form-section">
            <div class="form-group">
              <form action="{{ url_for('search_client') }}" method="POST">
    <label for="client_search">Buscar Cliente:</label>
    <select id="client_search" name="client_search" class="select2" required>
        <option value="">Seleccione un cliente</option>
        {% for client in clients %}
            <option value="{{ client.name }}">{{ client.name }}</option>
        {% endfor %}
    </select>
    <button type="submit">Buscar</button>
</form>
                    <!-- Opciones de cliente se llenarán con los resultados de búsqueda -->
                </select>
            </div>
            <div class="form-group">
                <label for="vehicle_search">Buscar Vehículo:</label>
                <input type="text" id="vehicle_search" name="vehicle_search" placeholder="Placa del Vehículo">
                <button type="button" onclick="searchVehicle()">Buscar</button>
                <select id="vehicle_id" name="vehicle_id" required>
                    <!-- Opciones de vehículo se llenarán con los resultados de búsqueda -->
                </select>
            </div>
        </div>
        
        <div class="form-section">
            <div class="form-group">
                <label for="priority">Prioridad:</label>
                <select id="priority" name="priority" required>
                    <option value="Alta">Alta</option>
                    <option value="Media" selected>Media</option>
                    <option value="Baja">Baja</option>
                </select>
            </div>
            <div class="form-group">
                <label for="area">Área:</label>
                <select id="area" name="area" required>
                    <option value="Entrada">Entrada</option>
                    <option value="Domicilio">Domicilio</option>
                    <option value="Reparación">Reparación</option>
                    <option value="Salida">Salida</option>
                </select>
            </div>
            <div class="form-group">
                <label for="status">Estado:</label>
                <select id="status" name="status" required>
                    <option value="Chequeo">Chequeo</option>
                    <option value="Sin Estado" selected>Sin Estado</option>
                </select>
            </div>
            <div class="form-group">
                <label for="work">Trabajo:</label>
                <textarea id="work" name="work" required></textarea>
            </div>
            <div class="form-group">
                <label for="general_status">Estado General:</label>
                <textarea id="general_status" name="general_status"></textarea>
            </div>
        </div>
        
        <div class="form-section">
            <div class="form-group">
                <label for="diagnosis">Diagnóstico:</label>
                <input type="text" id="diagnosis" name="diagnosis" required>
            </div>
            <div class="form-group">
                <label for="warranty">Garantía:</label>
                <input type="text" id="warranty" name="warranty" required>
            </div>
            <div class="form-group">
                <label for="mileage">Kilometraje:</label>
                <input type="number" id="mileage" name="mileage" required>
            </div>
            <div class="form-group">
                <label for="promised_date">Fecha Prometida:</label>
                <input type="date" id="promised_date" name="promised_date" required>
            </div>
            <div class="form-group">
                <label for="budget">Presupuesto:</label>
                <input type="number" id="budget" name="budget" required>
            </div>
            <div class="form-group">
                <label for="advance">Adelanto:</label>
                <input type="number" id="advance" name="advance" required>
            </div>
        </div>
        
        <div class="form-group button-group">
            <button type="button" onclick="showSignaturePopup()">Firmar</button>
        </div>
    </form>
</div>

<!-- Popup de Firma -->
<div id="signaturePopup" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Firma de Recepción</h5>
                <button type="button" class="close" onclick="hideSignaturePopup()" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Términos y condiciones de la recepción del vehículo...</p>
                <canvas id="signatureCanvas" width="500" height="200"></canvas>
                <input type="hidden" id="signature" name="signature">
                <p>Nombre del Cliente: <span id="client_name"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideSignaturePopup()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveSignature()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
    function searchClient() {
        var clientName = document.getElementById('client_search').value;
        fetch(`/search_client?name=${clientName}`)
            .then(response => response.json())
            .then(data => {
                var clientSelect = document.getElementById('client_id');
                clientSelect.innerHTML = ''; // Limpiar opciones previas
                data.clients.forEach(client => {
                    var option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.name;
                    clientSelect.appendChild(option);
                });
            });
    }

    function searchVehicle() {
        var vehiclePlate = document.getElementById('vehicle_search').value;
        fetch(`/search_vehicle?plate=${vehiclePlate}`)
            .then(response => response.json())
            .then(data => {
                var vehicleSelect = document.getElementById('vehicle_id');
                vehicleSelect.innerHTML = ''; // Limpiar opciones previas
                data.vehicles.forEach(vehicle => {
                    var option = document.createElement('option');
                    option.value = vehicle.id;
                    option.textContent = `${vehicle.license_plate} - ${vehicle.model}`;
                    vehicleSelect.appendChild(option);
                });
            });
    }

    function showSignaturePopup() {
        document.getElementById('signaturePopup').style.display = 'block';
    }

    function hideSignaturePopup() {
        document.getElementById('signaturePopup').style.display = 'none';
    }

    function saveSignature() {
        var canvas = document.getElementById('signatureCanvas');
        var signature = canvas.toDataURL('image/png');
        document.getElementById('signature').value = signature;
        hideSignaturePopup();
        document.querySelector('form').submit();
    }

    // Código para inicializar el canvas y capturar la firma
    var canvas = document.getElementById('signatureCanvas');
    var ctx = canvas.getContext('2d');
    var drawing = false;

    canvas.addEventListener('mousedown', function(e) {
        drawing = true;
        ctx.moveTo(e.clientX - canvas.offsetLeft, e.clientY - canvas.offsetTop);
    });

    canvas.addEventListener('mousemove', function(e) {
        if (drawing) {
            ctx.lineTo(e.clientX - canvas.offsetLeft, e.clientY - canvas.offsetTop);
            ctx.stroke();
        }
    });

    canvas.addEventListener('mouseup', function() {
        drawing = false;
    });

    canvas.addEventListener('mouseout', function() {
        drawing = false;
    });
</script>
{% endblock %}